[phases.setup]
nixPkgs = ["nodejs_22", "npm-9_x"]

[phases.install]
cmds = ["npm ci"]

[phases.build]
cmds = [
  "echo 'ğŸ—‘ï¸  Clearing build caches...'",
  "rm -rf frontend/dist || true",
  "rm -rf backend/dist || true",
  "rm -rf frontend/node_modules/.vite || true",
  "echo 'ğŸ“¦ Building backend...'",
  "npm run build --workspace=backend",
  "echo 'ğŸ¨ Building frontend...'",
  "npm run build --workspace=frontend",
  "echo 'ğŸ“ Copying frontend to backend public...'",
  "mkdir -p backend/dist/public",
  "cp -r frontend/dist/* backend/dist/public/"
]

[start]
cmd = "npm run start --workspace=backend"
